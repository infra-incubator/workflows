name: Build & Publish with Werf

on:
  workflow_call:
    inputs:
      skip_security:
        required: false
        type: boolean
        default: false
        description: 'Skip security checks (use when security is handled by caller)'
      multi_image:
        required: false
        type: boolean
        default: false
        description: 'Set to true for repos with multiple images in werf.yaml'
    outputs:
      git_sha:
        description: 'Short git SHA for image tagging'
        value: ${{ jobs.build.outputs.git_sha }}
    secrets:
      REGISTRY_HOST:
        required: true
      REGISTRY_REPO:
        required: true
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true

jobs:
  build:
    name: Build and Publish
    runs-on: [ self-hosted, k3s, infra ]
    if: always() && (inputs.skip_security == true || needs.security.outputs.security_passed == 'true')
    outputs:
      git_sha: ${{ steps.vars.outputs.sha_short }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup werf
        uses: werf/actions/install@v2

      - name: Build and publish image (main branch)
        if: github.ref == 'refs/heads/main'
        env:
          WERF_REPO: ${{ secrets.REGISTRY_HOST }}${{ secrets.REGISTRY_REPO }}
          SHA_SHORT: ${{ steps.vars.outputs.sha_short }}
        run: |
          werf cr login --insecure-registry=true --username ${{ secrets.REGISTRY_USERNAME }} --password ${{ secrets.REGISTRY_PASSWORD }} ${{ secrets.REGISTRY_HOST }}
          if [ "${{ inputs.multi_image }}" == "true" ]; then
            # Tag with both latest AND git SHA for unique identification
            werf build --add-custom-tag %image%-latest --add-custom-tag %image%-${SHA_SHORT} --insecure-registry=true
          else
            werf build --add-custom-tag latest --add-custom-tag ${SHA_SHORT} --insecure-registry=true
          fi

      - name: Build and publish image (other branches)
        if: github.ref != 'refs/heads/main'
        env:
          WERF_REPO: ${{ secrets.REGISTRY_REPO }}
          SHA_SHORT: ${{ steps.vars.outputs.sha_short }}
        run: |
          werf cr login --insecure-registry=true --username ${{ secrets.REGISTRY_USERNAME }} --password ${{ secrets.REGISTRY_PASSWORD }} ${{ secrets.REGISTRY_HOST }}
          if [ "${{ inputs.multi_image }}" == "true" ]; then
            werf build --add-custom-tag %image%-${GITHUB_REF_NAME} --add-custom-tag %image%-${SHA_SHORT} --insecure-registry=true
          else
            werf build --tag-git-branch --add-custom-tag ${SHA_SHORT} --insecure-registry=true
          fi