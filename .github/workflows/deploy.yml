name: Deploy

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
        description: 'Application name'
      environment:
        required: false
        default: 'dev'
        type: string
        description: 'Target environment (dev, staging, prod)'
      namespace:
        required: false
        type: string
        description: 'Kubernetes namespace (defaults to environment name)'
      auto_approve:
        required: false
        type: boolean
        default: false
        description: 'Auto approve deployment without manual confirmation'
      image_tag:
        required: false
        type: string
        default: 'latest'
        description: 'Image tag to deploy'
      values_file:
        required: false
        type: string
        default: ''
        description: 'Custom values file path (defaults to .helm/values-{environment}.yaml)'
      force_rollout:
        required: false
        type: boolean
        default: true
        description: 'Force rollout even if image tag unchanged (adds timestamp annotation)'
    secrets:
      REGISTRY_HOST:
        required: true
      REGISTRY_REPO:
        required: true
        description: 'Repository name (without host) in format: /org/repo'
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      KUBE_CONFIG:
        required: true
        description: 'Base64 encoded kubeconfig for target cluster'


jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: [ self-hosted, k3s, infra ]
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment }}.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Login to Container Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | helm registry login \
            ${{ secrets.REGISTRY_HOST }} \
            --username ${{ secrets.REGISTRY_USERNAME }} \
            --password-stdin

      - name: Check and create image pull secret
        env:
          NAMESPACE: ${{ inputs.namespace || inputs.environment }}
        run: |
          # Check if namespace exists
          if ! kubectl get namespace $NAMESPACE >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE doesn't exist, will be created by helm"
            NAMESPACE_EXISTS=false
            kubectl create namespace $NAMESPACE
          else
            echo "Namespace $NAMESPACE already exists"
            NAMESPACE_EXISTS=true
          fi

          # Check if image pull secret exists (only if namespace exists)
          if [ "$NAMESPACE_EXISTS" = "true" ] && kubectl get secret registry-secret -n $NAMESPACE >/dev/null 2>&1; then
            echo "Image pull secret already exists"
          else
           kubectl create secret docker-registry registry-secret \
              --docker-server=${{ secrets.REGISTRY_HOST }} \
              --docker-username=${{ secrets.REGISTRY_USERNAME }} \
              --docker-password=${{ secrets.REGISTRY_PASSWORD }} \
              --namespace $NAMESPACE
            echo "Image pull secret created successfully"
          fi

      - name: Deploy to environment
        env:
          NAMESPACE: ${{ inputs.namespace || inputs.environment }}
          ENVIRONMENT: ${{ inputs.environment }}
          VALUES_FILE: ${{ inputs.values_file || format('.helm/values-{0}.yaml', inputs.environment) }}
          FORCE_ROLLOUT: ${{ inputs.force_rollout }}
        run: |
          helm registry login ${{ secrets.REGISTRY_HOST }} --username ${{ secrets.REGISTRY_USERNAME }} --password ${{ secrets.REGISTRY_PASSWORD }}

          ROLLOUT_ARGS=""
          if [ "$FORCE_ROLLOUT" = "true" ]; then
            ROLLOUT_ARGS="--set podAnnotations.deployedAt=$(date +%s)"
          fi

          helm upgrade --install ${{ inputs.app_name }} oci://${{ secrets.REGISTRY_HOST }}/universal-helm/universal-helm \
            --namespace $NAMESPACE \
            --create-namespace \
            --set image.repository=${{ secrets.REGISTRY_HOST }}${{ secrets.REGISTRY_REPO }} \
            --set image.tag=${{ inputs.image_tag }} \
            --set image.pullPolicy=Always \
            --set environment=$ENVIRONMENT \
            $ROLLOUT_ARGS \
            --values $VALUES_FILE

      - name: Verify Deployment
        env:
          NAMESPACE: ${{ inputs.namespace || inputs.environment }}
        run: |
          kubectl get pods -n $NAMESPACE
          kubectl get services -n $NAMESPACE
          kubectl get ingress -n $NAMESPACE

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** ${{ inputs.namespace || inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY